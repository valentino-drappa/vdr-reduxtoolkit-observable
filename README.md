# vdr-reduxtoolkit-observable

This library facilitates the use of redux-observable with redux-toolkit.

## Installation

- npm
  - npm install vdr-reduxtoolkit-observable
- yarn
  - yarn add vdr-reduxtoolkit-observable

## prerequisite

To know more about redux-toolkit and redux-observable, please visit:

https://redux-toolkit.js.org/

https://redux-observable.js.org/

## Why to use the library

Basically, when we interact with an api, for each api call, we have 2 steps:

- call the api
- manage the api call result (success or error)

With redux-observable, we can convert these steps to 3 actions:
Redux action | Description
--- | ---
`fetch` |this action will trigger the api call
`fetchSuccess` |manage a successfull api call
`fetchError` |manage an api error call

These steps exist for each interaction with the api. If we have a read and update api call, we will have 6 actions ( 3 for the read api calls, 3 for the update api calls)

1. read_fetch ==> call the api
2. read_fetchSuccess ==> manage the sucess call
3. read_fetchError ==> manage the error call
4. update_fetch ==> call the api
5. update_fetchSuccess ==> manage the sucess call
6. update_fetchError ==> manage the error call

The library will create and manage for you these steps. All you have to do is to create the reducers for theses action.

## <ins>How to use it</ins>

### <ins>AbstractEpicReducer</ins>

This class represents your action reducers (fetch, fetchSuccess, fetchError). By extending the class you will implement 4 methods:

| Method         | Description                         |
| -------------- | ----------------------------------- |
| `fetchApiCall` | call the api                        |
| `fetch`        | reducer for the fetch action        |
| `fetchSuccess` | reducer for the fetch sucess action |
| `fetchError`   | reducer for the fetch error action  |

### <ins>AbstractSingleReducer</ins>

<b>This class represents the reducer for a single action. </b>

You can of course create an action which does not interact with redux-observable. You will use this class in order to manage a single action.

| Method          | Description             |
| --------------- | ----------------------- |
| `consumeAction` | reducer for your action |

### <ins>AbstractStateSlice</ins>

This class represents your state slice. It will generate and manage for you the redux-observable calls ( fetch,fetchSucces, fetchError) for each defined action (ex: read, update, delete, etc...)

### <ins><b>Use case</b></ins>

1. <ins>Api information</ins>

In our example, we will work with the rest point https://jsonplaceholder.typicode.com/posts/{postId}

This request will return a json with 4 information ( userId, id, title, body)

```javascript
/*  https://jsonplaceholder.typicode.com/posts/1 */
{
  "userId": 1,
  "id": 1,
  "title": "sunt aut facere repellat provident occaecati excepturi optio reprehenderit",
  "body": "quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"
}
```

2. <ins>App requirements and behaviours<ins>

a) the user will search a post by encoding a digit

b) In addition to displaying the post information, we want inform the user of the request status. The request status can be:

| Request status | Description          |
| -------------- | -------------------- |
| pending        | request on going     |
| success        | request has succeded |
| error          | request has failed   |

c) If an error occured, we want to display the error message.

d) Via a reset button the user will be able to clear the screen

3. <ins>Actions</ins>

Regarding the app requirements and behaviours, we will have 4 actions:

| Action Type           | Action Payload                | Description                                                                         |
| --------------------- | ----------------------------- | ----------------------------------------------------------------------------------- |
| post/readFetch        | post id to search             | this action will trigger the request call                                           |
| post/readFetchSuccess | contains the post information | this action will be triggered if the request has succeded                           |
| post/readFetchError   | request has failed            | this action will be triggered if the request has failed                             |
| post/reset            | null                          | this action will be triggered when the user will want to clear the post information |

Action types are generated by redux-toolkit. For more information aboout how it works please visit https://redux-toolkit.js.org/

3. <ins>Designing the state</ins>

In addition of the post information, we will add:

- the request status information.
- the error message if the request has failed

| State field  | Description                                        |
| ------------ | -------------------------------------------------- |
| userId       | post information                                   |
| id           | post information                                   |
| title        | post information                                   |
| body         | post information                                   |
| errorMessage | error message to display if the request has failed |
| fetchStatus  | request status                                     |

```javascript
/* represents the request possible status */
enum EFetchStatus {
  NONE = 'NONE',
  PENDING = 'PENDING',
  SUCCESS = 'SUCCESS',
  ERROR = 'ERROR',
}

/* represents the request success result */
interface PostInfos {
  userId: Number;
  id: Number;
  title: string;
  body: string;
}

/* represents the our slice state */
interface PostState extends PostInfos {
  errorMessage: string;
  fetchStatus: EFetchStatus;
}
```

4. <ins>Manage the api call</ins>

When the user searches a post

<b>1</b> an action post/readFetch is triggered<br />
<b>2,7</b> the reducer consume the action<br />
<b>3,8</b> the reducer update the state<br />
<b>4</b> check if a side effect exists for the action<br />
<b>5</b> make the api call<br />
<b>6a</b> Request succeded -> trigger a post/readFetchSuccess action<br />
<b>6b</b> Request failed -> trigger a post/readFetchError action<br />

![alt text](vdr-reduxtool-observable.jpg 'Redux-observalble schema')

<b>The redux-observable part is managed by the library.</b>

To manage our api call, we will use the class <b><ins>AbstractEpicReducer</ins></b>.
By using this class we will implement 4 methods:

| Method         | Description                         | schema step |
| -------------- | ----------------------------------- | ----------- | --- |
| `fetchApiCall` | call the api                        | 5           |     |
| `fetch`        | reducer for the fetch action        | 3           |
| `fetchSuccess` | reducer for the fetch sucess action | 8           |
| `fetchError`   | reducer for the fetch error action  | 8           |

<div style="background-color:#EFEFEF; color:black;padding:10px">

```
 extends AbstractEpicReducer<A,B,C>
```

| State field | Description                       |
| ----------- | --------------------------------- |
| A           | state type                        |
| B           | fetch action payload type         |
| C           | fetch action success payload type |

 </div>

```javascript
// represents the post/readFetch action payload */
interface ReadPostFetchPayload {
  postId: number;
}

// represents the post/readFetchSuccess action payload */
interface ReadPostFetchSuccessPayload extends PostInfos {}

// /!\ This interface is provided by the library
// represents the post/readFetchError action payload
interface FetchErrorPayload {
  errorCode: string;
  errorMsg: string;
  errorData: any;
}

class ReadPostReducer extends AbstractEpicReducer<PostState, ReadPostFetchPayload, ReadPostFetchSuccessPayload> {
  /* Step 5 - make the api call */
  fetchApiCall = (data: ReadPostFetchPayload) => findPostById(data.postId);

  /* Step 3 - reducer for the post/readFetch action */
  fetch = (state: PostState, data: ReadPostFetchPayload) => ({
    ...POST_STATE_INTITIAL_STATE,
    fetchStatus: EFetchStatus.PENDING,
  });

  /* Step 8 - reducer for the post/readFetchSuccess action */
  fetchSuccess = (state: PostState, data: ReadPostFetchSuccessPayload): PostState => ({
    ...data,
    errorMessage: '',
    fetchStatus: EFetchStatus.SUCCESS,
  });

  /*  Step 8 - reducer for the post/readFetchError action */
  fetchError = (state: PostState, data: FetchErrorPayload) => {
    return {
      ...POST_STATE_INTITIAL_STATE,
      errorMessage: data.errorMsg,
      fetchStatus: EFetchStatus.ERROR,
    };
  };
}
```

5. <ins>Manage the reset button with AbstractSingleReducer</ins>

When the user click on the reset button.

<b>1</b> an action post/reset is triggered<br />
<b>2</b> the reducer consume the action<br />
<b>3</b> the reducer update the state<br />

![alt text](vdr-reduxtool-observable-singleaction.jpg 'Redux-observalble schema')

To manage this action, we will use the class <b><ins>AbstractSingleReducer</ins></b>.
By using this class we will implement 1 method:

| Method                         | Description | schema step |
| ------------------------------ | ----------- | ----------- |
| `consumeAction(state, action)` |             | 3           |

<div style="background-color:#EFEFEF; color:black;padding:10px">

```javascript
 extends AbstractSingleReducer<A,B>
```

| State field | Description               |
| ----------- | ------------------------- |
| A           | state type                |
| B           | action (type and payload) |

 </div>

```javascript
class ResetPostReducer extends AbstractSingleReducer<PostState, null> {
  consumeAction = (state: PostState, action: Action<null>): PostState => POST_STATE_INTITIAL_STATE;
}
```

vdr-reduxtool-observable-singleaction.jpg

Full code here: https://github.com/valentino-drappa/vdr-reduxtoolkit-epic-example

#react #redux-toolkit #axios #redux-observable #rxjs
